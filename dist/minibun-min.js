const KEYWORDS=new Set(['break','case','catch','class','const','continue','debugger','default','delete','do','else','export','extends','finally','for','function','if','import','in','instanceof','let','new','return','super','switch','this','throw','try','typeof','var','void','while','with','yield','enum','await','async','of']);const PUNCTUATORS=new Set(['{','}','(',')','[',']','.',';',',',':','?','~','<','>','<=','>=','==','!=','===','!==','+','-','*','%','++','--','<<','>>','>>>','&','|','^','!','&&','||','??','=','+=','-=','*=','%=','<<=','>>=','>>>=','&=','|=','^=','=>','**','**=','/','?.','??=','||=','&&=',]);function isIdentifierStart(ch){return((ch>='a'&&ch<='z')||(ch>='A'&&ch<='Z')||ch==='$'||ch==='_');}function isIdentifierPart(ch){return isIdentifierStart(ch)||(ch>='0'&&ch<='9');}function isDecimalDigit(ch){return ch>='0'&&ch<='9';}function isRegexAllowedAfter(prevToken){if(!prevToken)return!0;if(prevToken.type==='keyword'){return['return','case','throw','else','do','typeof','instanceof','in','of'].includes(prevToken.value);}if(['punctuator'].includes(prevToken.type)){return['(','{','[',',',';','!','~','?','=',':','&&','||','??','+','-','*','/','%','&','|','^','<','>'].includes(prevToken.value);}return!1;}export function tokenize(code){const tokens=[];let i=0;const len=code.length;let prevSignificant=null;function push(type,value,start,end){const t={type,value,start,end};tokens.push(t);if(type!=='whitespace'&&type!=='comment'){prevSignificant=t;}}while(i<len){const start=i;let ch=code[i];if(/\s/.test(ch)){let j=i+1;while(j<len&&/\s/.test(code[j]))j++;push('whitespace',code.slice(i,j),i,j);i=j;continue;}if(ch==='/'&&code[i+1]==='/'){let j=i+2;while(j<len&&code[j]!=='\n'&&code[j]!=='\r')j++;push('comment',code.slice(i,j),i,j);i=j;continue;}if(ch==='/'&&code[i+1]==='*'){let j=i+2;while(j<len&&!(code[j]==='*'&&code[j+1]==='/'))j++;j=Math.min(j+2,len);push('comment',code.slice(i,j),i,j);i=j;continue;}if(ch==='\''||ch==='"'){const quote=ch;let j=i+1;while(j<len){const c=code[j];if(c==='\\'){j+=2;continue;}if(c===quote){j++;break;}j++;}push('string',code.slice(i,j),i,j);i=j;continue;}if(ch==='`'){let j=i+1;while(j<len){const c=code[j];if(c==='\\'){j+=2;continue;}if(c==='`'){j++;break;}if(c==='$'&&code[j+1]==='{'){j+=2;let depth=1;while(j<len&&depth>0){const d=code[j];if(d==='\\'){j+=2;continue;}if(d==='{')depth++;else if(d==='}')depth--;j++;}continue;}j++;}push('template',code.slice(i,j),i,j);i=j;continue;}if(isDecimalDigit(ch)||(ch==='.'&&isDecimalDigit(code[i+1]))){let j=i;if(ch==='0'&&(code[i+1]==='x'||code[i+1]==='X')){j+=2;while(j<len&&/[0-9a-fA-F]/.test(code[j]))j++;}else{while(j<len&&/[0-9]/.test(code[j]))j++;if(code[j]==='.'&&/[0-9]/.test(code[j+1])){j++;while(j<len&&/[0-9]/.test(code[j]))j++;}}push('number',code.slice(i,j),i,j);i=j;continue;}if(isIdentifierStart(ch)){let j=i+1;while(j<len&&isIdentifierPart(code[j]))j++;const value=code.slice(i,j);const type=KEYWORDS.has(value)?'keyword':'identifier';push(type,value,i,j);i=j;continue;}if(ch==='/'&&isRegexAllowedAfter(prevSignificant)){let j=i+1;let inClass=!1;while(j<len){const c=code[j];if(c==='\\'){j+=2;continue;}if(c==='['){inClass=!0;}else if(c===']'&&inClass){inClass=!1;}else if(c==='/'&&!inClass){j++;break;}j++;}while(j<len&&/[a-z]/i.test(code[j]))j++;push('regex',code.slice(i,j),i,j);i=j;continue;}let matched=null;for(const size of[3,2,1]){if(i+size<=len){const candidate=code.slice(i,i+size);if(PUNCTUATORS.has(candidate)){matched=candidate;break;}}}if(matched){push('punctuator',matched,i,i+matched.length);i+=matched.length;continue;}push('punctuator',ch,i,i+1);i+=1;}tokens.push({type:'eof',value:'',start:len,end:len});return tokens;}export function findModuleSyntax(tokens){const imports=[];const exports=[];let i=0;const len=tokens.length;function peek(offset=0){return tokens[i+offset]||tokens[len-1];}function consume(){const t=tokens[i];i+=1;return t;}function isFromKeyword(tok){return(tok.type==='identifier'||tok.type==='keyword')&&tok.value==='from';}while(i<len){const t=peek();if(t.type==='keyword'&&t.value==='import'){const startIndex=i;consume();let next=peek();if(next.type==='string'){imports.push({type:'side-effect',source:next.value.slice(1,-1)});consume();}else{while(!isFromKeyword(next)&&next.type!=='eof'){consume();next=peek();}if(isFromKeyword(next)){consume();while(peek().type==='whitespace')consume();const srcTok=peek();if(srcTok.type==='string'){imports.push({type:'import',source:srcTok.value.slice(1,-1),});consume();}}}while(peek().type!=='eof'&&peek().value!==';')consume();if(peek().value===';')consume();continue;}if(t.type==='keyword'&&t.value==='export'){consume();while(peek().type==='whitespace')consume();const n=peek();if(n.type==='punctuator'&&n.value==='*'){consume();while(peek().type==='whitespace')consume();let fromTok=peek();if(isFromKeyword(fromTok)){consume();while(peek().type==='whitespace')consume();const srcTok=peek();if(srcTok.type==='string'){exports.push({type:'all',source:srcTok.value.slice(1,-1),});consume();}}else{exports.push({type:'all'});}while(peek().type!=='eof'&&peek().value!==';')consume();if(peek().value===';')consume();continue;}if(n.type==='keyword'&&n.value==='default'){exports.push({type:'default'});while(peek().type!=='eof'&&peek().value!==';')consume();if(peek().value===';')consume();continue;}if(n.type==='punctuator'&&n.value==='{'){consume();const names=[];while(peek().type!=='eof'){const tk=consume();if(tk.type==='identifier'){names.push(tk.value);}else if(tk.type==='punctuator'&&tk.value==='}'){break;}}exports.push({type:'named',names});while(peek().type!=='eof'&&peek().value!==';')consume();if(peek().value===';')consume();continue;}if(n.type==='keyword'){consume();while(peek().type==='whitespace')consume();const idTok=peek();if(idTok.type==='identifier'){exports.push({type:'named',names:[idTok.value]});}while(peek().type!=='eof'&&peek().value!==';')consume();if(peek().value===';')consume();continue;}}consume();}return{imports,exports};}if(typeof module!=='undefined'&&module.exports){module.exports.tokenize=tokenize;module.exports.findModuleSyntax=findModuleSyntax;}export class TreeShaker{constructor(moduleMap){this.moduleMap=moduleMap instanceof Map?moduleMap:new Map(Object.entries(moduleMap));this.dependencyGraph=new Map();this.exportMap=new Map();this.reexports=new Map();this.sideEffects=new Map();}buildDependencyGraph(){for(const[name,code]of this.moduleMap.entries()){const imports=new Set();const exports=new Set();const reexports=new Set();const tokens=tokenize(code);const modSyntax=findModuleSyntax(tokens);for(const imp of modSyntax.imports){if(imp.source)imports.add(imp.source);}for(const exp of modSyntax.exports){if(exp.type==='default'){exports.add('default');}else if(exp.type==='named'&&exp.names){exp.names.forEach(n=>exports.add(n));}else if(exp.type==='all'){exports.add('*');if(exp.source)reexports.add(exp.source);}}let hasSideEffects=!1;for(const tok of tokens){if(tok.type==='identifier'&&(tok.value==='import'||tok.value==='export')){continue;}if(tok.type==='identifier'||tok.type==='punctuator'){if(tok.type==='identifier'&&tok.value==='new'){hasSideEffects=!0;break;}}}this.dependencyGraph.set(name,imports);this.exportMap.set(name,exports);this.reexports.set(name,reexports);this.sideEffects.set(name,hasSideEffects);}}markReachable(entryModule){const usedExports=new Map();const visited=new Set();const queue=[entryModule];while(queue.length){const mod=queue.pop();if(visited.has(mod))continue;visited.add(mod);const imports=this.dependencyGraph.get(mod)||new Set();const reexp=this.reexports.get(mod)||new Set();for(const dep of imports){const depExports=this.exportMap.get(dep)||new Set();if(!usedExports.has(dep))usedExports.set(dep,new Set());depExports.forEach(e=>usedExports.get(dep).add(e));if(!visited.has(dep))queue.push(dep);}for(const dep of reexp){if(!visited.has(dep))queue.push(dep);}if(!usedExports.has(mod))usedExports.set(mod,new Set());if(this.sideEffects.get(mod)){usedExports.get(mod).add('__side_effects__');}}return usedExports;}eliminateDeadCodeForModule(code,moduleName,usedExports){const hasAnyUsed=usedExports&&usedExports.size>0;const hasSideEffects=this.sideEffects.get(moduleName);if(!hasAnyUsed&&!hasSideEffects){return'';}return code;}shake(entryModule){this.buildDependencyGraph();const used=this.markReachable(entryModule);const output=new Map();for(const[name,code]of this.moduleMap.entries()){const usedExports=used.get(name)||new Set();if(name===entryModule){output.set(name,code);}else{const cleaned=this.eliminateDeadCodeForModule(code,name,usedExports);output.set(name,cleaned);}}return output;}}if(typeof module!=='undefined'&&module.exports){module.exports.TreeShaker=TreeShaker;}export class Minifier{constructor(options={}){this.options={keepComments:!1,...options,};}minify(code){const source=String(code);if(source.trim()==='')return'';if(this.options.keepComments){return source;}const tokens=tokenize(source);const transformed=[];for(const t of tokens){if(t.type==='comment')continue;if(t.type==='identifier'||t.type==='keyword'){if(t.value==='true'){transformed.push({...t,type:'code',value:'!0'});continue;}if(t.value==='false'){transformed.push({...t,type:'code',value:'!1'});continue;}}transformed.push(t);}function isWordLike(tok){return tok&&(tok.type==='identifier'||tok.type==='keyword'||tok.type==='number');}let out='';let prevSignificant=null;for(let i=0;i<transformed.length;i++){const tok=transformed[i];if(tok.type==='whitespace'){let j=i+1;let next=transformed[j];while(next&&next.type==='whitespace'){j+=1;next=transformed[j];}if(isWordLike(prevSignificant)&&isWordLike(next)){out+=' ';}continue;}out+=tok.value;if(tok.type!=='whitespace'&&tok.type!=='comment'){prevSignificant=tok;}}return out.trim();}}if(typeof module!=='undefined'&&module.exports){module.exports.Minifier=Minifier;}export class Bundler{constructor(moduleMap){this.moduleMap=moduleMap instanceof Map?moduleMap:new Map(Object.entries(moduleMap));this.graph=new Map();}extractImports(code){const deps=new Set();const tokens=tokenize(code);const{imports}=findModuleSyntax(tokens);for(const imp of imports){if(imp.source){deps.add(imp.source);}}return deps;}buildDependencyGraph(){for(const[name,code]of this.moduleMap.entries()){this.graph.set(name,this.extractImports(code));}}detectCircularDependencies(){const visited=new Set();const stack=new Set();const cycles=[];const dfs=(node)=>{if(stack.has(node)){cycles.push(node);return;}if(visited.has(node))return;visited.add(node);stack.add(node);const deps=this.graph.get(node)||new Set();for(const dep of deps){if(this.graph.has(dep))dfs(dep);}stack.delete(node);};for(const node of this.graph.keys()){dfs(node);}return cycles;}topologicalSort(entryModule){const visited=new Set();const visiting=new Set();const order=[];const visit=(mod)=>{if(visited.has(mod))return;if(visiting.has(mod)){return;}visiting.add(mod);const deps=this.graph.get(mod)||new Set();for(const dep of deps){if(this.moduleMap.has(dep)){visit(dep);}}visiting.delete(mod);visited.add(mod);order.push(mod);};if(this.moduleMap.has(entryModule)){visit(entryModule);}for(const mod of this.moduleMap.keys()){if(!visited.has(mod)){visit(mod);}}return order;}wrapModule(name,code){return`
/* Module: ${name} */
(function (modules, moduleName) {
  var module = { exports: {} };
  var exports = module.exports;
  (function (require, module, exports) {
${code}
  })(function (id) { return modules[id]; }, module, exports);
  modules[moduleName] = module.exports;
})(__modules__, '${name}');
`.trim();}bundle(entryModule){this.buildDependencyGraph();const cycles=this.detectCircularDependencies();if(cycles.length){console.warn('Circular dependencies detected:',cycles);}const order=this.topologicalSort(entryModule);const parts=[];parts.push('var __modules__ = {};');for(const name of order){const code=this.moduleMap.get(name);parts.push(this.wrapModule(name,code));}parts.push(`var __entry__ = __modules__['${entryModule}'];`);return parts.join('\n\n');}}if(typeof module!=='undefined'&&module.exports){module.exports.Bundler=Bundler;}export class ModuleSystem{constructor(){this.registry=new Map();this.cache=new Map();}define(name,dependencies,factory){this.registry.set(name,{dependencies,factory});}resolveDependencies(deps){return deps.map(d=>this.require(d));}require(name){if(this.cache.has(name)){return this.cache.get(name);}const record=this.registry.get(name);if(!record){throw new Error(`Module not defined: ${name}`);}const{dependencies,factory}=record;const module={exports:{}};const exports=module.exports;const resolved=this.resolveDependencies(dependencies);const result=factory(...resolved,module,exports);const finalExports=result!==undefined?result:module.exports;this.cache.set(name,finalExports);return finalExports;}async requireAsync(name){return Promise.resolve().then(()=>this.require(name));}async loadModule(path,name){let code;try{const response=await fetch(path);if(!response.ok){throw new Error(`Failed to fetch module: ${response.status} ${response.statusText}`);}code=await response.text();}catch(err){throw new Error(`Failed to load module "${name}" from "${path}": ${err.message}`);}try{const module={exports:{}};const exports=module.exports;const factory=new Function('module','exports',code+'\nreturn module.exports;');const result=factory(module,exports);const finalExports=result!==undefined?result:module.exports;this.cache.set(name,finalExports);return finalExports;}catch(err){throw new Error(`Failed to execute module "${name}": ${err.message}`);}}}if(typeof module!=='undefined'&&module.exports){module.exports.ModuleSystem=ModuleSystem;}const OBFUSCATOR_GLOBALS=new Set(['window','global','globalThis','document','console','Math','Date','JSON','Array','Object','String','Number','Boolean','RegExp','Promise','Set','Map','Buffer','atob','undefined','NaN','Infinity','Error','TypeError','ReferenceError','SyntaxError','RangeError','eval','parseInt','parseFloat','isNaN','isFinite','encodeURI','decodeURI','encodeURIComponent','decodeURIComponent','require','module','exports','__dirname','__filename',]);export class Obfuscator{constructor(options={}){this.options={encodeStrings:!0,renameIdentifiers:!1,flattenIfs:!1,...options,};this.idMap=new Map();}encodeStrings(code){if(!this.options.encodeStrings)return code;const tokens=tokenize(code);const toHexEscapes=(text)=>{let out='';for(let i=0;i<text.length;i++){const hex=text.charCodeAt(i).toString(16).padStart(2,'0');out+='\\x'+hex;}return out;};let out='';for(const tok of tokens){if(tok.type==='string'){const quote=tok.value[0];const inner=tok.value.slice(1,-1);const encoded=toHexEscapes(inner);out+=`${quote}${encoded}${quote}`;}else if(tok.type==='template'){if(!tok.value.includes('${')){const inner=tok.value.slice(1,-1);const encoded=toHexEscapes(inner);out+='`'+encoded+'`';}else{out+=tok.value;}}else{out+=tok.value;}}return out;}generateName(index){const chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';let name='';let n=index;do{name=chars[n%chars.length]+name;n=Math.floor(n/chars.length)-1;}while(n>=0);return name;}renameIdentifiers(code){if(!this.options.renameIdentifiers)return code;const tokens=tokenize(code);this.idMap.clear();for(let i=0;i<tokens.length;i++){const tok=tokens[i];if(tok.type!=='identifier')continue;if(!this.shouldRenameIdentifier(tokens,i))continue;if(this.idMap.has(tok.value))continue;const newName=this.generateName(this.idMap.size);this.idMap.set(tok.value,newName);}let out='';for(let i=0;i<tokens.length;i++){const tok=tokens[i];if(tok.type==='identifier'&&this.shouldRenameIdentifier(tokens,i)){const renamed=this.idMap.get(tok.value);out+=renamed||tok.value;}else{out+=tok.value;}}return out;}shouldRenameIdentifier(tokens,index){const tok=tokens[index];const name=tok.value;if(tok.type==='keyword')return!1;if(OBFUSCATOR_GLOBALS.has(name))return!1;let prevIdx=index-1;while(prevIdx>=0&&tokens[prevIdx].type==='whitespace'){prevIdx--;}if(prevIdx>=0){const prev=tokens[prevIdx];if(prev.type==='punctuator'&&(prev.value==='.'||prev.value==='?.')){return!1;}}return!0;}flattenControlFlow(code){if(!this.options.flattenIfs)return code;return code;}obfuscate(code,options={}){const opts={...this.options,...options};let out=code;if(opts.renameIdentifiers){out=this.renameIdentifiers(out);}if(opts.encodeStrings){out=this.encodeStrings(out);}if(opts.flattenIfs){out=this.flattenControlFlow(out);}return out;}}if(typeof module!=='undefined'&&module.exports){module.exports.Obfuscator=Obfuscator;}import fs from'node:fs/promises';import path from'node:path';export class Pipeline{constructor(options={}){this.entryFile=options.entryFile||'./index.js';this.modulesDir=options.modulesDir||'./src';this.outputFile=options.outputFile||'./dist/minibun.js';this.modules=options.modules||null;this.steps=[];}entry(entryFile){this.entryFile=entryFile;return this;}modulesRoot(dir){this.modulesDir=dir;return this;}output(outputFile){this.outputFile=outputFile;return this;}withModules(moduleMap){this.modules=moduleMap instanceof Map?moduleMap:new Map(Object.entries(moduleMap));return this;}useTreeShaker(options={}){this.steps.push({type:'treeShake',options});return this;}useDefaultProductionPipeline(options={}){const{treeShake=!0,obfuscate=!1,obfuscatorOptions={},}=options;if(treeShake)this.useTreeShaker();this.useBundler().useMinifier();if(obfuscate)this.useObfuscator(obfuscatorOptions);return this;}useBundler(options={}){this.steps.push({type:'bundle',options});return this;}useMinifier(options={}){this.steps.push({type:'minify',options});return this;}useObfuscator(options={}){this.steps.push({type:'obfuscate',options});return this;}static fromJSON(config){const pipeline=new Pipeline({entryFile:config.entry||'./index.js',modulesDir:config.modulesDir||'./src',outputFile:config.output||'./dist/minibun.js',});const p=config.pipeline||{};if(p.treeShake)pipeline.useTreeShaker(p.treeShake===!0?{}:p.treeShake);if(p.bundle!==!1)pipeline.useBundler(p.bundle===!0?{}:p.bundle);if(p.minify)pipeline.useMinifier(p.minify===!0?{}:p.minify);if(p.obfuscate)pipeline.useObfuscator(p.obfuscate===!0?{}:p.obfuscate);if(pipeline.steps.length===0){pipeline.useBundler().useMinifier();}return pipeline;}async run(){let current=this.modules||(await this.loadModules());for(const step of this.steps){switch(step.type){case'treeShake':{const shaker=new TreeShaker(current);current=shaker.shake(this.entryFile);break;}case'bundle':{const bundler=new Bundler(current);current=bundler.bundle(this.entryFile);break;}case'minify':{const minifier=new Minifier(step.options);current=minifier.minify(String(current));break;}case'obfuscate':{const obfuscator=new Obfuscator(step.options);current=obfuscator.obfuscate(String(current));break;}default:throw new Error(`Unknown pipeline step: ${step.type}`);}}if(this.outputFile){await this.writeOutput(current,this.outputFile);}return current;}async writeOutput(value,filePath){const dir=path.dirname(filePath);await fs.mkdir(dir,{recursive:!0});if(value instanceof Uint8Array){await fs.writeFile(filePath,value);}else{await fs.writeFile(filePath,String(value),'utf8');}}async loadModules(){const root=this.modulesDir;const modules=new Map();const walk=async(dir)=>{const entries=await fs.readdir(dir,{withFileTypes:!0});for(const entry of entries){const full=path.join(dir,entry.name);if(entry.isDirectory()){await walk(full);}else if(entry.isFile()&&entry.name.endsWith('.js')){const rel='./'+path.relative(root,full).replace(/\\/g,'/');const code=await fs.readFile(full,'utf8');modules.set(rel,code);}}};await walk(root);return modules;}}if(typeof module!=='undefined'&&module.exports){module.exports.Pipeline=Pipeline;}if(typeof module!=='undefined'&&module.exports){module.exports={TreeShaker,Minifier,Bundler,ModuleSystem,Obfuscator,Pipeline};}